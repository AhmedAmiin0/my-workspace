name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Install dependencies
      run: |
        cd backend-apps
        pnpm install
        
    - name: Build backend
      run: |
        cd backend-apps
        npx nx run customer-backend:build --configuration=production
        
    - name: Build Docker image
      run: |
        docker build -f Dockerfile -t customer-backend .
        
    - name: Test Docker image
      run: |
        docker run --rm customer-backend node --version
        docker run --rm customer-backend pnpm --version
        
    - name: Copy backend files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: 148.230.116.195
        username: root
        key: |
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABCE5Y18X2
          UNRZ+tA/PCfyE/AAAAGAAAAAEAAAAzAAAAC3NzaC1lZDI1NTE5AAAAIBslgWt/ggXzi5H6
          wE0bVWW7IljYyj7g2PHokA0sMPneAAAAoOMthg25i6itHp2e/zIvbGr393bkVVZwxIFPlg
          Utj3UIoyGBS5MCa4phC6edXMfKZfolhWRaqu04uH9fFDz00c9VKo4DintAg+v6TonaotQD
          Tckg/WhpsR2wfx/NzWFLozJCK63UhmXwwxHjbxhBfY+3XJNqvXYGx0xkBrWEtJhJEzDOMs
          UWY24u7dixPhc4uECJSAsBMC5E79KujmOX41A=
          -----END OPENSSH PRIVATE KEY-----
        passphrase: amin
        source: "."
        target: "/var/project/"
        debug: true
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 148.230.116.195
        username: root
        key: |
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABCE5Y18X2
          UNRZ+tA/PCfyE/AAAAGAAAAAEAAAAzAAAAC3NzaC1lZDI1NTE5AAAAIBslgWt/ggXzi5H6
          wE0bVWW7IljYyj7g2PHokA0sMPneAAAAoOMthg25i6itHp2e/zIvbGr393bkVVZwxIFPlg
          Utj3UIoyGBS5MCa4phC6edXMfKZfolhWRaqu04uH9fFDz00c9VKo4DintAg+v6TonaotQD
          Tckg/WhpsR2wfx/NzWFLozJCK63UhmXwwxHjbxhBfY+3XJNqvXYGx0xkBrWEtJhJEzDOMs
          UWY24u7dixPhc4uECJSAsBMC5E79KujmOX41A=
          -----END OPENSSH PRIVATE KEY-----
        passphrase: amin
        debug: true
        script: |
          # Navigate to project directory
          cd /var/project
          
          # Comprehensive cleanup of all containers and networks
          echo "Performing comprehensive cleanup..."
          
          # Stop all running containers
          docker stop $(docker ps -q) || true
          
          # Remove all containers
          docker rm $(docker ps -aq) || true
          
          # Remove unused networks
          docker network prune -f || true
          
          # Clean up any dangling images
          docker image prune -f || true
          
          echo "Cleanup completed, starting fresh deployment..."
          
          # Build Docker image on server
          docker build -f Dockerfile -t customer-backend:latest .
          
          # Check if port 3000 is still in use and find an alternative
          PORT=3000
          while netstat -tuln | grep -q ":$PORT "; do
            echo "Port $PORT is in use, trying next port..."
            PORT=$((PORT + 1))
          done
          echo "Using port $PORT for the application"
          
          # Run new container in production mode
          docker run -d \
            --name customer-backend \
            --restart unless-stopped \
            -p $PORT:3000 \
            -e NODE_ENV=production \
            -e DATABASE_URL=postgresql://postgres:password@postgres:5432/customer_app \
            -e MONGODB_URI=mongodb://mongo:27017/customer_app \
            -e REDIS_URL=redis://redis:6379 \
            customer-backend:latest
          
          # Show running containers
          docker ps
          
          # Show container logs
          docker logs customer-backend
          
          # Check if container is running
          if ! docker ps | grep -q customer-backend; then
            echo "Container failed to start. Checking logs..."
            docker logs customer-backend
            exit 1
          fi
          
          # Test the health endpoint
          sleep 10
          curl -f http://localhost:$PORT/health || echo "Health check failed on port $PORT"
          echo "Application is running on port $PORT"
