name: Frontend Android Build

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend-apps/**'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build for'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - all

jobs:
  trigger-android-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Install dependencies
      run: |
        cd frontend-apps
        pnpm install
        
    - name: Install EAS CLI
      run: |
        npm install -g eas-cli
        
    - name: Login to EAS
      run: |
        echo "Logging into EAS..."
        # Note: You'll need to set up EAS_TOKEN as a repository secret
        # eas login --non-interactive --token ${{ secrets.EAS_TOKEN }}
        # For now, we'll use the existing login
        eas whoami || echo "Not logged in, will use existing session"
        
    - name: Trigger Android Build (Non-blocking)
      run: |
        cd frontend-apps
        echo "🚀 Triggering Android build on EAS..."
        
        # Trigger the Android build in background without waiting
        nohup npx eas build --platform android --non-interactive > android-build.log 2>&1 &
        
        # Give it a moment to start
        sleep 5
        
        echo "✅ Android build process started in background"
        echo "📱 Android APK will be generated on EAS servers"
        echo "📋 Build ID will be available in android-build.log"
        
        # Show the first few lines of the log to confirm it started
        head -10 android-build.log || echo "Android build log not yet available"
        
    - name: Android Build Status
      run: |
        echo "✅ Android APK build has been triggered on EAS"
        echo "📱 Android build is running in the background"
        echo "🔗 Check Android build status at: https://expo.dev/accounts/holdmycup/projects/customer-app/builds"
        echo "⏱️  Android build typically takes 5-15 minutes to complete"
        echo "📧 You'll receive an email notification when the Android APK is ready"
        echo "📱 You'll get a downloadable APK file when complete"
        
    - name: Export Web Build (Fallback)
      run: |
        cd frontend-apps
        echo "Also creating a web export as fallback..."
        npx nx export customer-app --platform web
        echo "✅ Web build completed and available in dist/ directory"
